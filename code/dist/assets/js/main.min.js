const draw=SVG().addTo("#canvas");var info={foo:null};const bgpic={width:800,height:450,originalWidth:1920,originalHeight:1080,filename:"../assets/bg_small.jpg"},secondaryfont={family:"ArvoGruen",size:15,anchor:"left",weight:700};function message(e=!1){e?$("#message").show().html(e):$("#message").hide()}function closeOverlay(){Math.max(document.documentElement.clientWidth,window.innerWidth||0);$('head meta[name="viewport"]').attr("content","width=800, initial-scale=0.4"),$(".overlay.active").removeClass("active")}function setDrawsize(){let e=$("#width").val(),a=$("#height").val(),i=e/a;for(config.socialmediaplatform="",e>800&&(a=(e=800)/i);a>800;)a=(e-=50)/i;draw.size(e,a),$("#canvas").width(draw.width()),$("#canvas").height(draw.height()),calculateSizes(),text.bounce(),pin.bounce(),window.setTimeout(logo.draw,100)}function resetDrawsize(){$("#width").val(info.originalWidth),$("#height").val(info.originalHeight),setDrawsize()}function setDimensions(e,a){$("#width").val(e),$("#height").val(a),setDrawsize()}function calculateSizes(){$("#textsize").attr("min",.1*draw.width()),$("#textsize").attr("max",draw.width()),$("#textsize").val(.3*draw.width()),$("#textX").val(0),$("#textY").val(draw.height()/5),$("#pinX").val(.7*draw.width()),$("#pinY").val(.5*draw.height()),$("#backgroundsize").attr("min",draw.width()),$("#backgroundsize").attr("max",5*draw.width()),$("#backgroundsize").val(draw.width()),$("#backgroundX").val(0),$("#backgroundY").val(0),reset()}function getEncodingStatus(){$.ajax({url:"../getvideoencodestatus.php?videofile="+config.videofile,type:"GET",dataType:"JSON",success:function(e){let a=Math.round(100*e.currentposition/config.videoduration);$("#download").html(a+"% des Videos sind schon fertig. Bitte warten.")}})}function uploadImageByUrl(e,a=function(){}){$("#waiting").addClass("active");let i=new FormData;client=new XMLHttpRequest,i.append("id","uploadbyurl"),i.append("url2copy",e),client.onerror=function(e){console.log("onError",e)},client.upload.onprogress=function(e){let a=Math.round(100/e.total*e.loaded);$("#uploadpercentage").html(a),a>99&&$("#uploadstatus").html("Dein Bild wird verarbeitet...")},client.onload=function(e){let i=JSON.parse(e.target.response);closeOverlay(),i.error&&console.log(i),config.filename=i.filename,afterUpload(i),a()},client.open("POST","../upload.php"),client.send(i)}function afterUpload(e){draw.size(e.width,e.height),info.originalWidth=e.originalWidth,info.originalHeight=e.originalHeight,info.previewWidth=draw.width(),info.previewHeight=draw.height(),$("#backgroundURL").val(e.filename),$("#width").val(e.originalWidth),$("#height").val(e.originalHeight),$("#fullBackgroundName").val(e.fullBackgroundName),setDrawsize(),background.draw(),pin.draw(),window.setTimeout(text.draw,10)}$(document).ready(function(){afterUpload(bgpic),window.setTimeout(load,1e3),$("[data-click]").click(function(){window[$(this).data("click")]()})}),$("#color-scheme").bind("change",function(){$("body").toggleClass("dark")}),$(".close").click(closeOverlay),closeOverlay(),$(".size").bind("input propertychange",setDrawsize),$("#sizereset").click(resetDrawsize),$("#sizepresets").on("change",function(){setDimensions(...this.value.split(":")),config.socialmediaplatform=$("#sizepresets option:selected").data("socialmediaplatform"),$(this).val($("#sizepresets option:first").val())}),$("#download").click(function(){$(this).prop("disabled",!0);let e,a=$(this).html();config.video?($(this).html('<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Das Video wird erstellt ...</span>'),window.setTimeout(function(){e=window.setInterval(function(){getEncodingStatus()},3e3)},3e3)):$(this).html('<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Augenblick bitte'),$("#canvas").addClass("opacity");let i="jpg";1==config.video&&(i="mp4",background.svg.hide());let t=draw.svg();1==config.video&&background.svg.show(),$.ajax({type:"POST",url:"../createpic.php",data:{svg:t,format:i,usepixabay:config.usePixabay,socialmediaplatform:config.socialmediaplatform,videofile:config.videofile,width:$("#width").val()},success:function(t,o,n){let r=JSON.parse(t);$("#download").prop("disabled",!1),$("#canvas").removeClass("opacity"),$("#download").html(a),window.clearInterval(e);let s=$("#text").val().toLowerCase();s=(s=(s=(s=(s=(s=s.replace(/[ä|ö|ü|ß]/g,function(e){switch(e){case"ä":return"ae";case"ö":return"oe";case"ü":return"ue";case"ß":return"ss"}})).replace(/[^a-zA-Z0-9]/g,"-")).replace(/\-+/g,"-")).replace(/^\-/g,"")).replace(/\-$/g,"")).substring(0,20),config.socialmediaplatform&&(s=s.substring(0,14)+"-"+config.socialmediaplatform.toLowerCase()),window.location.href="../download.php?file="+r.basename+"&format="+i+"&downloadname="+s}})}),$(".upload-file").change(function(e){let a=$(this).attr("id"),i=document.getElementById(a).files[0];if(document.getElementById(a).files[0].size/1024/1024>100)return alert("Die Datei ist zu groß. Es sind maximal 100 MB erlaubt.\n\nSchicke Dir die Datei per z.B. WhatsApp zu, dann wird sie automatisch verkleinert. Mehr als 20 MB pro Minute Video braucht es nicht."),!1;$("#waiting").addClass("active"),$(this).prop("disabled",!0);let t=new FormData;client=new XMLHttpRequest,i&&(t.append("file",i),t.append("id",a),t.append("user",config.user),t.append("accesstoken",config.accesstoken),client.onerror=function(e){console.log("onError",e)},client.onload=function(e){let i=JSON.parse(e.target.response);if($("#"+a).prop("disabled",!1),$("#waiting").removeClass("active"),i.error)return console.log(i.error),!1;switch(config.video=1==i.video,config.videofile=i.videofile,config.filename=i.filename,config.videoduration=i.videoduration,a){case"uploadfile":afterUpload(i);break;case"uploadlogo":$("#logoselect").val("custom"),logo.load();break;case"uploadicon":$("#iconfile").val(i.iconfile),icon.load(),$(".iconsizeselectwrapper").removeClass("d-none");break;default:console.log("error in upload",i)}},client.upload.onprogress=function(e){let a=Math.round(100/e.total*e.loaded);$("#uploadpercentage").html(a)},client.onabort=function(e){console.log("Upload abgebrochen")},client.open("POST","../upload.php"),client.send(t))}),$(".uploadfileclicker").click(function(){$("#uploadfile").click()}),$(".uploadlogoclicker").click(function(){$("#uploadlogo").click()}),$(".uploadiconclicker").click(function(){$("#uploadicon").click()});const background={svg:draw.circle(0),isLoaded:!1,draw(){this.svg.remove();let e=$("#backgroundURL").val();this.svg=draw.image(e,function(e){this.back().draggable(),background.isLoaded=!0,background.resize(),background.svg.move(parseInt($("#backgroundX").val()),parseInt($("#backgroundY").val())),this.on("dragend.namespace",function(e){$("#backgroundX").val(Math.round(this.x())),$("#backgroundY").val(Math.round(this.y())),background.uncoveredAreaWarning()})})},blackwhite:function(){$("#graybackground").prop("checked")?this.svg.filterWith(function(e){e.colorMatrix("saturate",0)}):this.svg.unfilter()},reset:function(){$("#backgroundX").val(0),$("#backgroundY").val(0),$("#backgroundsize").val(parseInt($("#backgroundsize").prop("min"))),this.draw(),background.uncoveredAreaWarning()},resize:function(){let e=parseInt($("#backgroundsize").val());if(this.svg.size(e),background.hasRoundingError()){let e=parseInt($("#backgroundsize").val());$("#backgroundsize").val(e+=5),this.resize()}background.uncoveredAreaWarning()},hasRoundingError:function(){return draw.height()-background.svg.height()>0},uncoveredAreaWarning:function(){if(!this.isLoaded)return!1;let e=!1;switch($("#design").val()){case"bigright":this.svg.x()>0&&(e=!0),this.svg.y()>0&&(e=!0),this.svg.y()+this.svg.height()<draw.height()&&(e=!0);break;default:this.svg.x()>0&&(e=!0),this.svg.x()+this.svg.width()<draw.width()&&(e=!0),this.svg.y()>0&&(e=!0),this.svg.y()+this.svg.height()<draw.height()&&(e=!0)}e?message('Im Bild entsteht ein weißer Rand. Platziere das Bild neu, <u class="cursor-pointer" onClick="background.reset();">setze es zurück</u> oder vergrößere es.'):message()}};function blackwhite(){background.blackwhite()}function save(){let e=$("#pic").serialize();$.post("../save.php",{user:config.user,action:"save",data:e,accesstoken:config.accesstoken}).done(function(e){$("#load").removeClass("d-none"),$("#delete").removeClass("d-none"),$(".saving-response").html("Gespeichert.").delay(2e3).fadeOut()})}function unlink(){confirm("Zwischenspeicherung wirklich löschen?")&&$.post("../save.php",{user:config.user,action:"delete",accesstoken:config.accesstoken}).done(function(e){$(".saving-response").html("Gelöscht.").delay(2e3).fadeOut(),$("#load").addClass("d-none"),$("#delete").addClass("d-none")})}function load(){$.post("../get.php",{user:config.user,action:"getSavedPic",accesstoken:config.accesstoken}).done(function(e){let a=JSON.parse(e),i=JSON.parse(a.data);if(!a.data)return!1;for(var t in $("#load").removeClass("d-none"),$("#delete").removeClass("d-none"),$("#width").val(i.width),$("#height").val(i.height),setDrawsize(),i)$("#"+t).val(i[t]);["textsamesize","greenbehindtext"].forEach(function(e){"on"===i[e]&&$("#"+e).prop("checked",!0)}),window.setTimeout(function(){text.draw(),logo.load(),background.draw(),copyright.draw(),pin.draw(),icon.load()},100),window.setTimeout(function(){copyright.draw(),pin.draw()},500)})}$("#backgroundreset").click(function(){background.reset()}),$("#backgroundsize").bind("input propertychange",function(){background.resize()}),$("#copyright").bind("input propertychange",function(){copyright.draw()}),$(".copyright-change-color").click(function(){copyrightColorIndex++,copyrightColorIndex%=copyrightColors.length,copyright.draw()});let copyrights={};function setCopyright(e,a){copyrights[a]="pixabay"==a?"Foto: "+e+"@pixabay.com":"Icon: "+e,$("#copyright").val(Object.values(copyrights).join(", ")),copyright.draw(),copyright.draw()}var copyrightColors=["white","black","#46962b","#E6007E","#FEEE00"],copyrightColorIndex=0;const copyrightfont={family:"Arial",size:9,anchor:"left",weight:300},copyright={svg:draw.text(""),draw(){copyright.svg.remove(),copyright.svg=draw.text($("#copyright").val()).font(copyrightfont).fill(copyrightColors[copyrightColorIndex]).move(10,draw.height()-12).rotate(-90,copyright.svg.x(),copyright.svg.y())}};$("#pixabayopener").click(function(){$('head meta[name="viewport"]').attr("content","width=device-width, initial-scale=1"),$("#pixabay").addClass("active")}),$("#pixabay-form").submit(function(e){return e.preventDefault(),getPixabayImages($("#pixabay .q").val()),!1});var page=1;function getPixabayVideos(e){console.log("Suche Videos für "+e),$("#videos-tab").tab("show"),$("#pixabay-videos .results").html("Suche Videos ... ");let a="https://pixabay.com/api/videos/?key="+config.pixabay.apikey+"&q="+encodeURIComponent(e)+"&page="+page+"&per_page=100";$.ajax({url:a,success:function(e,a,i){$("#pixabay-videos .results").html(""),e.hits.forEach(function(e){$("#pixabay-videos .results").append('<img src="'+e.userImageURL+'" data-url="'+e.videos.medium.url+'" data-user="'+e.user+'" class="img-fluid">')}),$("#pixabay-videos .results>img").click(function(){let e=$(this).data("user");uploadImageByUrl($(this).data("url"),function(){setCopyright(e,"pixabay"),config.usePixabay="pixabay"})})},error:function(e,a,i){console.log(e,i)}})}function getPixabayImages(e){let a="https://pixabay.com/api/?key="+config.pixabay.apikey+"&q="+encodeURIComponent(e)+"&image_type=photo&page="+page+"&per_page=100";$("#images-tab").tab("show"),$("#pixabay-images .results").html("Suche Bilder ... "),$.ajax({url:a,success:function(e,a,i){$("#pixabay-images .results").html(""),e.hits.forEach(function(e){$("#pixabay-images .results").append('<img src="'+e.previewURL+'" data-url="'+e.largeImageURL+'" data-user="'+e.user+'" class="img-fluid">')}),$("#pixabay-images .results>img").click(function(){let e=$(this).data("user");uploadImageByUrl($(this).data("url"),function(){setCopyright(e,"pixabay"),config.usePixabay="pixabay"})})},error:function(e,a,i){console.log(e,i)}})}$('a[data-toggle="tab"]').on("shown.bs.tab",function(e){e.target,e.relatedTarget,"videos-tab"==$(e.target).attr("id")&&getPixabayVideos($("#pixabay .q").val())}),$("#templateopener").click(function(){$('head meta[name="viewport"]').attr("content","width=device-width, initial-scale=1"),$("#templates").addClass("active")}),$(".templatepic").click(function(){let e=$(this),a=$(this).data("attribution");uploadImageByUrl($(this).data("url"),function(){setCopyright(a,"");let i=e.data("text").replace(/@/g,"!").replace(/§/g,"\n");$("#text").val(i),$("#textX").val(e.data("x")),$("#textY").val(e.data("y")),$("#textsize").val(e.data("size"))})});